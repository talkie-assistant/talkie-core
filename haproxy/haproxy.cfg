global
    log stdout format raw local0
    maxconn 4096
    # Do not use 'daemon' in containers: the process must stay in foreground

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option forwardfor
    option http-server-close

# Stats endpoint
frontend stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE

# Main frontend (bind 8080: rootless Podman cannot bind to 80)
frontend talkie_frontend
    bind *:8080
    # SSL binding (optional, uncomment and provide cert if needed)
    # bind *:443 ssl crt /usr/local/etc/haproxy/certs/talkie.pem
    
    # Speech module
    acl is_speech path_beg /speech
    use_backend speech_backend if is_speech
    
    # RAG module
    acl is_rag path_beg /rag
    use_backend rag_backend if is_rag
    
    # Browser module
    acl is_browser path_beg /browser
    use_backend browser_backend if is_browser
    
    # Default to speech
    default_backend speech_backend

# Consul DNS on port 8600 (avoids root-only port 53 in rootless Podman)
resolvers consul
    nameserver consul 172.30.0.2:8600
    accepted_payload_size 8192
    hold valid 5s

# Backends use Consul DNS (*.service.consul) via resolver above.
# init-addr none: do not resolve at startup (HAProxy starts before modules may register).
# Backend: Speech module
backend speech_backend
    option httpchk GET /health
    http-check expect status 200
    default-server init-addr none
    server speech speech.service.consul:8001 check inter 5s fall 3 rise 2 resolvers consul

# Backend: RAG module
backend rag_backend
    option httpchk GET /health
    http-check expect status 200
    default-server init-addr none
    server rag rag.service.consul:8002 check inter 5s fall 3 rise 2 resolvers consul

# Backend: Browser module
backend browser_backend
    option httpchk GET /health
    http-check expect status 200
    default-server init-addr none
    server browser browser.service.consul:8003 check inter 5s fall 3 rise 2 resolvers consul
